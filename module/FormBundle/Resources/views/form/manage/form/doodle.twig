{% extends 'manage/base.twig' %}

{% block content %}
    {% if authenticatedPerson is not null %}
        <h2>{{ formSpecification.getTitle(language) }}</h2>
        <p>{{ translate('Person') }}: <b>{{ formEntry.getPersonInfo().getFullName() }}</b></p>

        {% if doodleNotValid %}
            <div class="flashmessage alert alert-error fade in">
                <a class="close" data-dismiss="alert">&times;</a>
                {{ translate('Your subscriptions couldn\'t be saved.') }}
            </div>
        {% endif %}
        {% do form.prepare() %}
        {% autoescape false %}{{ form().openTag(form) }}{% endautoescape %}
            <table class="table table-bordered table-striped" id="doodle">
                <tr>
                    <th>{{ translate('Date') }}</th>
                    <th width="300px">{{ translate('Location') }}</th>
                    <th width="200px">{{ translate('Subscribe') }}</th>
                </tr>
                {% for field in formSpecification.getFields() %}
                    <tr {% if formElementErrors(form.get('field-' ~ field.getId())) %}class="error"{% endif %}>
                        <td>
                            {{ field.getLabel(language) }}
                        </td>
                        <td>
                            {{ field.getLocation(language) }}
                            {% if field.getExtraInformation(language) %}
                                <a href="#" class="extraInformation pull-right" data-content="{{ field.getExtraInformation(language) }}"><i class="icon-info-sign"></i></a>
                            {% endif %}
                        </td>
                        <td>
                            {% if occupiedSlots[field.getId()] %}
                                {% if formSpecification.getNamesVisibleForOthers() %}
                                    <i>{{ occupiedSlots[field.getId()] }}</i>
                                {% else %}
                                    <i>{{ translate('Occupied') }}</i>
                                {% endif %}
                            {% else %}
                                <label class="checkbox" style="margin: 2px 0">
                                    {{ formElement(form.get('field-' ~ field.getId())) }}
                                </label>
                            {% endif %}
                        </td>
                    </tr>
                {% endfor %}
            </table>

            {% if formSpecification.isEditableByUser() %}
                <div class="form-actions">
                    <div class="row">
                        <span class="label"></span>
                        <span class="field">
                            {{ formElement(form.get('submit')) }}
                        </span>
                    </div>
                </div>
            {% endif %}
        {% autoescape false %}{{ form().closeTag() }}{% endautoescape %}
    {% else %}
        <div style="text-align: center;">
            <img src="/img/litus.png" alt="Litus" />
            <h3>{{ translate('Please login to get access to these pages.') }}</h3>
        </div>
    {% endif %}
{% endblock %}

{% block content_script %}
    <script type="text/javascript">
        $(document).ready(function () {
            $('.extraInformation').popover({'trigger': 'hover'});

            $('table label.checkbox').each(function () {
                $(this).hide();
                $(this).parent().append(
                    $('<button>', {'class': 'btn btn-primary btn-small'}).html('{{ translate('Subscribe') }}').click(function (e) {
                        e.preventDefault();
                        var checkbox = $(this).parent().find('input[type=checkbox]');
                        if (checkbox.is(':checked')) {
                            checkbox.prop('checked', false);
                            $(this).html('{{ translate('Subscribe') }}').removeClass('btn-danger');
                        } else {
                            checkbox.prop('checked', true);
                            $(this).html('{{ translate('Unsubscribe') }}').addClass('btn-danger');
                        }
                    })
                );

                if ($(this).find('input[type=checkbox]').is(':checked')) {
                    $(this).parent().find('button').html('{{ translate('Unsubscribe') }}').addClass('btn-danger');
                } else {
                    $(this).parent().find('button').html('{{ translate('Subscribe') }}').removeClass('btn-danger');
                }
            });

            {% if not formSpecification.isMultiple() %}
                $('#doodle input[type=checkbox]').click(function () {
                    $('#doodle input[type=checkbox]').prop('checked', false);
                    $(this).prop('checked', true);
                });
            {% endif %}
        });
    </script>
{% endblock %}