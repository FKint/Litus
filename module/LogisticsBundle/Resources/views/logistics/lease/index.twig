{% extends 'logistics/base.twig' %}
{% import 'site/partials/form.twig' as forms %}

{% block content %}
<div class="row">
    <div class="span6">
        <div class="page-header">
            <h1>{{ translate('Lease') }}</h1>
        </div>
        {{ forms.renderForm(leaseForm) }}
    </div>
    <div class="span6">
        <div class="page-header">
            <h1>{{ translate('Return') }}</h1>
        </div>
        {{ forms.renderForm(returnForm) }}
    </div>
</div>
<div class="row">
    <div class="span12">
        <div class="page-header">
            <h1>{{ translate('Leases') }} <small>{{ translate('Items currently leased') }}</small></h1>
        </div>
        <table class="table">
            <thead>
                <tr>
                    <th>{{ translate('Item name') }}</th>
                    <th>{{ translate('Barcode') }}</th>
                    <th>{{ translate('Leased to') }}</th>
                    <th>{{ translate('Leased on') }}</th>
                    <th>{{ translate('Pawn') }}</th>
                    <th>{{ translate('Actions') }}</th>
                </tr>
            </thead>
            <tbody>
                {% for lease in leases %}
                    <tr data-barcode="{{ lease.getItem().getBarcode() }}" data-pawn="{{ lease.getLeasedPawn() }}">
                        <td>{{ lease.getItem().getName() }}</td>
                        <td>{{ lease.getItem().getBarcode() }}</td>
                        <td>{{ lease.getLeasedTo() }}</td>
                        <td>{{ lease.getLeasedDate()|date }}</td>
                        <td>{{ lease.getLeasedPawn()|number_format(2) }}</td>
                        <td>
                            <span class="js-item-return btn btn-mini">{{ translate('Return') }}</span>
                            <a href="{{ url('logistics_lease',{ 'action': 'show', 'id': lease.getId() }) }}" class="btn btn-mini">{{ translate('Details') }}</a>
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
        {% include 'site/partials/paginationControl.twig' %}
    </div>
</div>
<div class="row">
    <div class="span12">
        <div class="page-header">
            <h1>{{ translate('Item search') }}</h1>
        </div>
        <form action="{{ url('logistics_lease', {'action': 'history' }) }}" id="search">
            <div class="input-append">
                <input class="js-item-search" type="text">
                <input type="hidden" class="js-item-barcode" name="barcode">
                <button class="btn">{{ translate('Search') }}</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block content_script %}
<script>
    (function() {
        /*
         * Monkey-patch of typeaheadRemote to prevent sending search queries when
         * a barcode is being entered in the field.
         */
        var origLookup = $.fn.typeaheadRemote.Constructor.prototype.lookup;
        $.fn.typeaheadRemote.Constructor.prototype.lookup = function(event) {
            if(/^[0-9]{1,12}$/.test(this.$element.val())) {
                return this.shown? this.hide(): this;
            } else {
                return origLookup.call(this, event)
            }
        };

    })();

    $('.js-item-search').change(function() {
        var $this = $(this);
        var $form = $this.parents('form');
        $form.find('.js-additional_info').remove();
        var $barcode = $form.find('.js-item-barcode');
        if(/^[0-9]{12}$/.test($this.val())) {
            $barcode.val($this.val()).change();
        } else if ($this.data('value')) {
            $barcode.val($this.data('value').id);
            if($this.data('value').additional_info) {
                $this.parent().append('<span class="help-block js-additional_info">'+$this.data('value').additional_info+'</span>');
            }
        } else {
            $barcode.val('');
        }
    });

    $('#lease .js-item-search').typeaheadRemote({
        source: "{{ url('logistics_lease', { 'action': 'typeahead' }) }}?purpose=lease&q="
    });

    $('#return .js-item-search').typeaheadRemote({
        source: "{{ url('logistics_lease', { 'action': 'typeahead' }) }}?purpose=return&q="
    });

    $('#search .js-item-search').typeaheadRemote({
        source: "{{ url('logistics_lease', { 'action': 'typeahead' }) }}?purpose=search&q="
    });

    $('.js-item-barcode').change(function() {
        var $this = $(this);
        if($this.val().length < 12)
            return;
        var $control_group = $this.prev();
        $control_group.removeClass('error').removeClass('success');
        var $controls = $control_group.find('.controls');
        $controls.find('.help-inline').hide();
        var $form = $control_group.parents('form');
        var $submit = $form.find('.btn');
        function error(text) {
            $control_group.addClass('error');
            $submit.attr({disabled: true});
            $controls.append('<div class="help-inline"><ul><li>'+text+'</li></ul></div>');
        }
        function success() {
            $control_group.addClass('success');
            $submit.attr({disabled: false});
        }
        $.get("{{ url('logistics_lease', {'action':'availabilityCheck'}) }}"+$this.val(), function(data) {
            if(!data)
                return;
            switch(data.status) {
                case 'noSuchItem':
                    error('{{ translate('No lease item with this barcode exists') }}');
                    break;
                case 'leased':
                    if($form.attr('id') === 'lease') {
                        error('{{ translate('This item is already leased') }}');
                    } else {
                        success();
                    }
                    break;
                case 'returned':
                    if($form.attr('id') === 'return') {
                        error('{{ translate('This item is already returned') }}');
                    } else {
                        success();
                    }
                    break;
            }
        }, 'json');
    });

    $('#leased_to, #returned_by').typeaheadRemote({
        source: "{{ url('common_admin_academic_typeahead') }}"
    });

    $('.js-item-return').click(function() {
        var $tr =  $(this).parents('tr');
        var barcode = $tr.data('barcode');
        var pawn = $tr.data('pawn');
        $('#return .js-item-barcode, #return .js-item-search').val(barcode);
        $('#returned_pawn').val(pawn);
        $('#returned_by').focus();
    });

</script>
{% endblock %}
