{% extends 'admin/base.twig' %}

{% block content %}
    {% include 'quiz/admin/quiz/partials/navigation.twig' %}

    {% include 'admin/partials/flashMessenger.twig' %}

    <div class="flashmessage success_message full_width points_update_success hide">
        <div class="title">Success</div>
        <div class="content">
            <p>The points were successfully updated!</p>
        </div>
    </div>
    <div class="flashmessage error_message full_width points_update_error hide">
        <div class="title">Error</div>
        <div class="content">
            <p>An error occurred while trying to update the points.</p>
        </div>
    </div>
    <div class="flashmessage error_message full_width points_load_error hide">
        <div class="title">Error</div>
        <div class="content">
            <p>An error occurred while trying to load the points.</p>
        </div>
    </div>
    <div id="controller_action">
        <table class="full_width manage">
            <thead>
                <tr>
                    <th>Team</th>
                    {% for round in rounds %}
                        <th data-round-id="{{ round.getId() }}">{{ round.getName() }}</th>
                    {% endfor %}
                </tr>
            </thead>

            <tbody>
                {% for team in teams %}
                    <tr class="item" data-team-id="{{ team.getId() }}">
                        <td>{{ team.getName() }}</td>
                        {# XXX: Probably needs some love #}
                        {% for round in rounds %}
                            <td data-round-id="{{ round.getId() }}" data-team-id="{{ team.getId() }}" contenteditable>...</td>
                        {% endfor %}
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
{% endblock %}

{% block content_script %}
    <script type="text/javascript">
        $(document).ready(getPoints());
        function getPoints() {
            $('#controller_action').addClass('quiz_loading');
            $.getJSON('{{ url('quiz_admin_quiz', {'action': 'points', 'id': quiz.getId()}) }}', function(data) {
                $('#controller_action td[contenteditable]').text('0');
                for(var i in data) {
                    var point = data[i];
                    $('#controller_action td[data-team-id="'+point.team+'"][data-round-id="'+point.round+'"]').text(point.value);
                }
                $('#controller_action').removeClass('quiz_loading');
            }).error(errorLoad);
        }
        $('#controller_action td[contenteditable]').on('blur', function() { updatePoint($(this)); });
        function updatePoint($elem) {
            $elem.addClass('quiz_saving');
            $elem.removeClass('quiz_save_error');
            var round_id = $elem.data('round-id');
            var team_id = $elem.data('team-id');
            $.post(
                    '{{ url('quiz_admin_quiz', {'action': 'addPoint', 'id': quiz.getId() }) }}',
                    {
                        'round': round_id,
                        'team': team_id,
                        'points': $elem.text()
                    },
                    function (data) {
                        if(data && data.status === "success") {
                            $('.flashmessage').addClass('hide');
                            $('.points_update_succcess').removeClass('hide');
                            $elem.removeClass('quiz_saving');
                        }
                        else {
                            errorUpdate($elem);
                        }
                    },
                    'json'
            ).error(function() { errorUpdate($elem); });
        }

        function errorUpdate($elem) {
            $elem.removeClass('quiz_saving');
            $elem.addClass('quiz_save_error');
            $('.flashmessage').addClass('hide');
            $('.points_update_error').removeClass('hide');
        }

        function errorLoad() {
            $('.flashmessage').addClass('hide');
            $('.points_load_error').removeClass('hide');
        }
    </script>
    <style type="text/css">
            .quiz_loading {
                cursor: wait;
            }
            .quiz_saving {
                background-color: orange !important;
                cursor: progress;
            }
            .quiz_save_error {
                background-color: red !important;
            }
    </style>
{% endblock %}
